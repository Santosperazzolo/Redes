<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Formulario ABM</title>
    <style>
      :root{
        --azul:#a7c3d8;
        --azul-borde:#88acc2;
        --menta:#98f0dc;
        --gris:#9aa6b2;
        --texto:#111;
      }
      html,body{height:100%}
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--texto);margin:0;background:#fff}
      h1{font-size:28px;margin:18px 16px 4px}
      .wrap{max-width:980px;margin:0 auto 40px;background:var(--menta);padding:16px 16px 24px;box-sizing:border-box;border-top:4px solid #82d4c4}
      .panel{
        background:var(--azul);
        border:1px solid var(--azul-borde);
        padding:16px;box-sizing:border-box;
      }
      .cols{display:grid;grid-template-columns:360px 1fr;gap:14px;align-items:start}
      .grid{display:grid;grid-template-columns:110px 1fr;column-gap:10px;row-gap:10px}
      label{align-self:center;font-weight:600}
      input[type="text"], input[type="number"]{width:220px;padding:7px 8px;border:1px solid var(--gris);border-radius:3px}
      input[type="number"]{text-align:right}
      .msg{min-height:18px;font-size:12px;color:#b00020;margin-top:2px}
      .ok{color:#0a7b12}
      .actions{display:flex;gap:10px;justify-content:center;margin-top:16px}
      .actions button{padding:8px 12px;border:1px solid #c2b7c0;background:#e9dfe6;border-radius:3px;font-weight:600}
      .actions button:disabled{opacity:.6}
      table{width:100%;border-collapse:collapse;background:#f6fffc}
      th,td{border:1px solid #bfeee3;padding:6px 8px;text-align:left}
      th{background:#e3fbf4}
      tfoot td{font-weight:600}
      .small{font-size:12px;color:#555;margin:8px 0 0}
    </style>
  </head>
  <body>
    <h1>FORMULARIO ABM</h1>

    <div class="wrap">
      <div class="cols">
        <div class="panel">
          <div class="grid">
            <label for="apellido">Apellido</label>
            <div>
              <input id="apellido" type="text" autocomplete="off" />
              <div id="msgApellido" class="msg" aria-live="polite"></div>
            </div>

            <label for="nombres">Nombres</label>
            <div>
              <input id="nombres" type="text" autocomplete="off" />
              <div id="msgNombres" class="msg" aria-live="polite"></div>
            </div>

            <label for="saldo">Saldo</label>
            <div>
              <input id="saldo" type="number" step="0.01" inputmode="decimal" />
              <div id="msgSaldo" class="msg" aria-live="polite"></div>
            </div>
          </div>
        </div>

        <div>
          <table aria-label="Listado de registros" id="tabla">
            <thead>
              <tr><th>Apellido</th><th>Nombres</th><th style="width:120px">Saldo</th></tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr><td colspan="3">Total registros: <span id="count">0</span></td></tr>
            </tfoot>
          </table>
          <div class="small">Consejo: escriba Apellido y Nombres; si existe, se cargará el Saldo.</div>
        </div>
      </div>

      <div class="actions">
        <button id="btnReset" type="button">Blanquear</button>
        <button id="btnAlta" type="button" disabled>Alta</button>
        <button id="btnModi" type="button" disabled>Modi</button>
        <button id="btnBaja" type="button" disabled>Baja</button>
      </div>
    </div>

    <script>
      const KEY = 'abmPersonas';
      let datos = [];

      function cargar(){
        try{
          const raw = localStorage.getItem(KEY);
          datos = raw? JSON.parse(raw): [];
        }catch{ datos = []; }
      }
      function guardar(){
        localStorage.setItem(KEY, JSON.stringify(datos));
      }
      function normalizarTexto(v){
        return String(v || '').trim().replace(/\s+/g,' ');
      }
      function clave(apellido,nombres){
        return normalizarTexto(apellido).toLowerCase()+ '|' + normalizarTexto(nombres).toLowerCase();
      }
      function buscar(apellido,nombres){
        const k = clave(apellido,nombres);
        return datos.findIndex(r => clave(r.apellido,r.nombres)===k);
      }
      function ordenar(){
        datos.sort((a,b)=>{
          const aa = a.apellido.localeCompare(b.apellido, 'es', {sensitivity:'base'});
          if(aa!==0) return aa;
          return a.nombres.localeCompare(b.nombres, 'es', {sensitivity:'base'});
        });
      }

      // ---- DOM ----
      const $apellido = document.getElementById('apellido');
      const $nombres  = document.getElementById('nombres');
      const $saldo    = document.getElementById('saldo');
      const $msgA     = document.getElementById('msgApellido');
      const $msgN     = document.getElementById('msgNombres');
      const $msgS     = document.getElementById('msgSaldo');
      const $btnReset = document.getElementById('btnReset');
      const $btnAlta  = document.getElementById('btnAlta');
      const $btnModi  = document.getElementById('btnModi');
      const $btnBaja  = document.getElementById('btnBaja');
      const $tbody    = document.querySelector('#tabla tbody');
      const $count    = document.getElementById('count');

      function setMsg(el, msg, ok){
        el.textContent = msg || '';
        el.classList.toggle('ok', !!ok);
      }
      function validar(){
        const a = normalizarTexto($apellido.value);
        const n = normalizarTexto($nombres.value);
        const s = String($saldo.value);
        const tieneAyN = a.length>0 && n.length>0;
        const saldoNum = Number(s);
        const saldoOk = s.length>0 && !Number.isNaN(saldoNum);

        setMsg($msgA, a? '': 'Requerido');
        setMsg($msgN, n? '': 'Requerido');
        setMsg($msgS, saldoOk? '': 'Numérico');

        const idx = tieneAyN? buscar(a,n) : -1;
        if(tieneAyN && idx>=0){
          if(document.activeElement!==$saldo){
            $saldo.value = String(datos[idx].saldo);
          }
          $btnAlta.disabled = true;
          $btnModi.disabled = !saldoOk;
          $btnBaja.disabled = false;
        }else{
          $btnAlta.disabled = !(tieneAyN && saldoOk);
          $btnModi.disabled = true;
          $btnBaja.disabled = true;
        }
      }

      function render(){
        ordenar();
        $tbody.innerHTML = datos.map(r=>`<tr><td>${r.apellido}</td><td>${r.nombres}</td><td style="text-align:right">${r.saldo.toFixed(2)}</td></tr>`).join('');
        $count.textContent = String(datos.length);
        validar();
      }

      $btnReset.addEventListener('click', ()=>{
        $apellido.value = '';
        $nombres.value  = '';
        $saldo.value    = '';
        setMsg($msgA,''); setMsg($msgN,''); setMsg($msgS,'');
        $btnAlta.disabled = true; $btnModi.disabled = true; $btnBaja.disabled = true;
        $apellido.focus();
      });
      $btnAlta.addEventListener('click', ()=>{
        const a = normalizarTexto($apellido.value);
        const n = normalizarTexto($nombres.value);
        const s = Number($saldo.value);
        if(buscar(a,n)>=0){ alert('El registro ya existe'); return; }
        datos.push({apellido:a, nombres:n, saldo:s});
        guardar();
        render();
      });
      $btnModi.addEventListener('click', ()=>{
        const a = normalizarTexto($apellido.value);
        const n = normalizarTexto($nombres.value);
        const s = Number($saldo.value);
        const i = buscar(a,n);
        if(i<0){ alert('No existe el registro'); return; }
        datos[i].saldo = s;
        guardar();
        render();
      });
      $btnBaja.addEventListener('click', ()=>{
        const a = normalizarTexto($apellido.value);
        const n = normalizarTexto($nombres.value);
        const i = buscar(a,n);
        if(i<0){ alert('No existe el registro'); return; }
        if(confirm('¿Confirma la baja?')){
          datos.splice(i,1);
          guardar();
          render();
          $btnReset.click();
        }
      });

      $apellido.addEventListener('keyup', validar);
      $nombres.addEventListener('keyup', validar);
      $saldo.addEventListener('keyup', validar);

      cargar();
      if(datos.length===0){
        datos = [
          {apellido:'Gomez',   nombres:'Ana',   saldo: 1500.50},
          {apellido:'Perez',   nombres:'Luis',  saldo:  250.00},
          {apellido:'Rodriguez', nombres:'Marta', saldo:  980.75},
        ];
        guardar();
      }
      render();
      $apellido.focus();
    </script>
  </body>
  </html>
