<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pagos</title>
  <style>
    :root {
      --page-bg: #f7efcb;
      --panel-border: #8c8268;
      --header-bg: #f7efcb;
      --button-bg: #c5c2bc;
      --button-border: #8c8268;
      --button-shadow: rgba(0, 0, 0, 0.18);
      --table-header-bg: #f1624d;
      --table-header-text: #2a100d;
      --table-body-bg: #9ecff4;
      --table-filler-bg: #8bc8ea;
      --table-footer-bg: #f1624d;
      --table-footer-text: #2a100d;
      --text-main: #2f2a24;
      font-size: 16px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Times New Roman', Times, serif;
      background: var(--page-bg);
      color: var(--text-main);
    }

    .page-wrapper {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      border: 2px solid var(--panel-border);
      box-shadow: 0 12px 32px rgba(55, 50, 35, 0.26);
      background: var(--page-bg);
    }

    header {
      padding: 38px clamp(28px, 8vw, 80px) 28px;
      border-bottom: 2px solid var(--panel-border);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 22px;
    }

    header h1 {
      margin: 0;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      font-size: 1.9rem;
    }

    .actions {
      display: flex;
      gap: 16px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .actions button {
      min-width: 190px;
      padding: 14px 24px;
      font-size: 1.05rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      border: 1px solid var(--button-border);
      border-radius: 4px;
      background: var(--button-bg);
      box-shadow: 0 4px 0 var(--button-shadow);
      cursor: pointer;
      transition: filter 0.2s ease;
    }

    .actions button:hover {
      filter: brightness(1.05);
    }

    .actions button:active {
      transform: translateY(2px);
      box-shadow: 0 2px 0 var(--button-shadow);
    }

    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(14, 12, 8, 0.58);
      padding: 28px;
      z-index: 1000;
    }

    .modal.is-visible {
      display: flex;
    }

    .modal__dialog {
      width: min(920px, 94vw);
      max-height: 92vh;
      display: flex;
      flex-direction: column;
      border: 2px solid var(--panel-border);
      border-radius: 10px;
      background: var(--page-bg);
      box-shadow: 0 20px 44px rgba(27, 22, 12, 0.4);
      overflow: hidden;
    }

    .modal__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      background: var(--table-header-bg);
      color: var(--table-header-text);
      padding: 18px 24px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: bold;
    }

    .modal__close {
      background: none;
      border: none;
      color: inherit;
      font-size: 1.55rem;
      line-height: 1;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
    }

    .modal__close:hover {
      opacity: 0.7;
    }

    .modal__body {
      flex: 1;
      padding: 0;
      background: var(--table-body-bg);
    }

    .modal__iframe {
      width: 100%;
      height: 70vh;
      border: none;
      background: #ffffff;
      display: block;
    }

    @media (max-width: 768px) {
      .modal__iframe {
        height: 78vh;
      }
    }

    main {
      flex: 1;
      display: flex;
      padding: 22px clamp(28px, 7vw, 88px) 28px;
      overflow: hidden;
    }

    .table-panel {
      flex: 1;
      border: 2px solid var(--panel-border);
      border-radius: 6px;
      background: var(--table-body-bg);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .table-wrapper {
      flex: 1;
      overflow-y: auto;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }

    thead th {
      background: var(--table-header-bg);
      color: var(--table-header-text);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      padding: 18px 22px;
      border-bottom: 2px solid var(--panel-border);
      font-size: 1.05rem;
      text-align: left;
    }

    tbody {
      background: var(--table-body-bg);
    }

    tbody td {
      padding: 18px 22px;
      font-size: 1rem;
      border-bottom: 1px solid rgba(0, 0, 0, 0.08);
      background: rgba(255, 255, 255, 0.18);
    }

    tbody tr:nth-child(even) td {
      background: rgba(255, 255, 255, 0.32);
    }

    tbody .filler td {
      height: 100%;
      padding: 0;
      border-bottom: none;
      background: none;
    }

    tbody .filler div {
      height: 100%;
      min-height: 200px;
      background: var(--table-filler-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(0, 0, 0, 0.3);
      font-size: 1.2rem;
    }

    td.numero {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    tfoot {
      background: var(--table-footer-bg);
      color: var(--table-footer-text);
    }

    tfoot td {
      padding: 16px 18px;
      border-top: 2px solid var(--panel-border);
      letter-spacing: 0.04em;
      font-weight: bold;
    }

    footer {
      padding: 20px 32px;
      text-align: center;
      border-top: 2px solid var(--panel-border);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: bold;
      background: var(--page-bg);
    }

    @media (max-width: 1024px) {
      header {
        padding: 28px clamp(18px, 12vw, 40px);
        gap: 16px;
      }

      header h1 {
        font-size: 1.5rem;
      }

      .actions button {
        min-width: 160px;
        font-size: 0.95rem;
      }

      thead th {
        padding: 12px 10px;
        font-size: 0.9rem;
      }

      tbody td {
        padding: 12px 10px;
        font-size: 0.9rem;
      }

      tfoot td {
        padding: 12px 10px;
        font-size: 0.85rem;
      }
    }
  </style>
</head>
<body>
  <div class="page-wrapper">
    <header>
      <h1>Pagos</h1>
      <div class="actions">
        <button type="button" id="btAccionCarga">Cargar datos</button>
        <button type="button" id="btAccionVaciar">Vaciar datos</button>
        <button type="button" id="btAccionForm">Cargar Form</button>
      </div>
    </header>

    <div class="modal" id="formModal" role="dialog" aria-modal="true" aria-labelledby="formModalTitle" aria-hidden="true">
      <div class="modal__dialog">
        <div class="modal__header">
          <span id="formModalTitle">Formulario</span>
          <button type="button" class="modal__close" id="modalCloseBtn" aria-label="Cerrar formulario">&times;</button>
        </div>
        <div class="modal__body">
          <iframe class="modal__iframe" src="../Ej01FormVariableArregloDeObjetos/index.html" title="Formulario de carga"></iframe>
        </div>
      </div>
    </div>

    <main>
      <section class="table-panel" aria-live="polite">
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th scope="col">ID Contrato</th>
                <th scope="col">DNI Deudor</th>
                <th scope="col">Cuota Nro</th>
                <th scope="col">Cliente</th>
                <th scope="col">Fecha Pago</th>
                <th scope="col">Monto Pagado</th>
              </tr>
            </thead>
            <tbody id="tbDatos">
              <tr class="filler">
                <td colspan="6"><div>No hay datos cargados</div></td>
              </tr>
            </tbody>
          </table>
        </div>
        <table>
          <tfoot>
            <tr>
              <td id="sumCodArt">Contratos: 0</td>
              <td id="sumFamilia">DNIs: 0</td>
              <td id="sumUm">Cuotas: 0</td>
              <td id="sumDescripcion">Clientes: 0</td>
              <td id="sumFechaAlta">Sin fechas</td>
              <td id="sumSaldoStock">Total: $0,00</td>
            </tr>
          </tfoot>
        </table>
      </section>
    </main>

    <footer>Sistema de Gestión de Pagos</footer>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script>
    $(document).ready(function() {
      const currencyFormatter = new Intl.NumberFormat('es-AR', {
        style: 'currency',
        currency: 'ARS',
        minimumFractionDigits: 2
      });

      const integerFormatter = new Intl.NumberFormat('es-AR');

      let formModalKeyHandler = null;
      let lastFocusedBeforeModal = null;

      function openFormModal() {
        const formModal = $('#formModal');
        if (formModal.hasClass('is-visible')) {
          return;
        }
        lastFocusedBeforeModal = document.activeElement;
        formModal.attr('class', 'modal is-visible');
        formModal.attr('aria-hidden', 'false');
        
        formModalKeyHandler = function(event) {
          if (event.key === 'Escape') {
            event.preventDefault();
            closeFormModal();
          }
        };
        $(document).on('keydown', formModalKeyHandler);
        
        setTimeout(function() {
          $('#modalCloseBtn').focus();
        }, 100);
      }

      function closeFormModal() {
        const formModal = $('#formModal');
        formModal.attr('class', 'modal');
        formModal.attr('aria-hidden', 'true');
        
        if (formModalKeyHandler) {
          $(document).off('keydown', formModalKeyHandler);
          formModalKeyHandler = null;
        }
        
        if (lastFocusedBeforeModal) {
          lastFocusedBeforeModal.focus();
        } else {
          $('#btAccionForm').focus();
        }
      }

      function escapeHtml(value) {
        return String(value ?? '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function formatearFecha(valor) {
        if (!valor) {
          return '';
        }
        const fecha = new Date(valor);
        return isNaN(fecha.getTime()) ? escapeHtml(valor) : fecha.toLocaleDateString('es-AR');
      }

      function obtenerFechaMasReciente(actual, candidata) {
        if (!candidata) {
          return actual;
        }
        if (!actual) {
          return candidata;
        }
        const fechaActual = new Date(actual);
        const fechaCandidata = new Date(candidata);
        
        if (isNaN(fechaActual.getTime()) || isNaN(fechaCandidata.getTime())) {
          return actual;
        }
        return fechaCandidata > fechaActual ? candidata : actual;
      }

      function resetTabla() {
        $('#tbDatos').empty();
        const fillerRow = '<tr class="filler"><td colspan="6"><div>No hay datos cargados</div></td></tr>';
        $('#tbDatos').append(fillerRow);
        resetFooter();
      }

      function resetFooter() {
        $('#sumCodArt').text('Contratos: 0');
        $('#sumFamilia').text('DNIs: 0');
        $('#sumUm').text('Cuotas: 0');
        $('#sumDescripcion').text('Clientes: 0');
        $('#sumFechaAlta').text('Sin fechas');
        $('#sumSaldoStock').text('Total: $0,00');
      }

      function actualizarFooter(datos) {
        $('#sumCodArt').text('Contratos: ' + integerFormatter.format(datos.contratos));
        $('#sumFamilia').text('DNIs: ' + integerFormatter.format(datos.dnis));
        $('#sumUm').text('Cuotas: ' + integerFormatter.format(datos.cuotasTotal));
        $('#sumDescripcion').text('Clientes: ' + integerFormatter.format(datos.clientes));
        $('#sumFechaAlta').text(datos.fechaReciente ? 'Último pago: ' + formatearFecha(datos.fechaReciente) : 'Sin fechas');
        $('#sumSaldoStock').text('Total: ' + currencyFormatter.format(datos.montoTotal));
      }

      function renderTabla(data) {
        if (!data || data.length === 0) {
          resetTabla();
          return;
        }

        $('#tbDatos').empty();

        const contratos = new Set();
        const dnis = new Set();
        const clientes = new Set();
        let cuotasTotal = 0;
        let montoTotal = 0;
        let fechaReciente = '';

        data.forEach(function(pago) {
          const contrato = pago.IdContrato;
          const dni = pago.DNIDeudor;
          const cuota = Number(pago.CuotaNro) || 0;
          const cliente = pago.Apellido_Nombres;
          const fechaPago = pago.FechaPago;
          const monto = Number(pago.MontoPagado) || 0;

          if (contrato) contratos.add(contrato);
          if (dni) dnis.add(dni);
          if (cliente) clientes.add(cliente);
          cuotasTotal += cuota;
          montoTotal += monto;
          fechaReciente = obtenerFechaMasReciente(fechaReciente, fechaPago);

          const objTr = document.createElement('tr');
          
          const objTd1 = document.createElement('td');
          objTd1.setAttribute('campo-dato', 'IdContrato');
          objTd1.innerHTML = escapeHtml(contrato);
          objTr.appendChild(objTd1);

          const objTd2 = document.createElement('td');
          objTd2.setAttribute('campo-dato', 'DNIDeudor');
          objTd2.innerHTML = escapeHtml(dni);
          objTr.appendChild(objTd2);

          const objTd3 = document.createElement('td');
          objTd3.setAttribute('campo-dato', 'CuotaNro');
          objTd3.setAttribute('class', 'numero');
          objTd3.innerHTML = integerFormatter.format(cuota);
          objTr.appendChild(objTd3);

          const objTd4 = document.createElement('td');
          objTd4.setAttribute('campo-dato', 'Apellido_Nombres');
          objTd4.innerHTML = escapeHtml(cliente);
          objTr.appendChild(objTd4);

          const objTd5 = document.createElement('td');
          objTd5.setAttribute('campo-dato', 'FechaPago');
          objTd5.innerHTML = formatearFecha(fechaPago);
          objTr.appendChild(objTd5);

          const objTd6 = document.createElement('td');
          objTd6.setAttribute('campo-dato', 'MontoPagado');
          objTd6.setAttribute('class', 'numero');
          objTd6.innerHTML = currencyFormatter.format(monto);
          objTr.appendChild(objTd6);

          $('#tbDatos').append(objTr);
        });

        actualizarFooter({
          contratos: contratos.size,
          dnis: dnis.size,
          cuotasTotal: cuotasTotal,
          clientes: clientes.size,
          fechaReciente: fechaReciente,
          montoTotal: montoTotal
        });
      }

      $('#btAccionCarga').click(function() {
        const boton = $(this);
        boton.prop('disabled', true);
        boton.text('Cargando...');
        
         $.get('Pagos.json', function(pagosData) {
  if (pagosData && Array.isArray(pagosData.PagoCuotasTransferencia)) {
    renderTabla(pagosData.PagoCuotasTransferencia);
  } else {
    resetTabla();
  }
}).fail(function() {
  alert('Error al cargar el archivo pagos.json');
  resetTabla();
}).always(function() {
  boton.disabled = false;
  boton.textContent = 'Cargar datos';
});
      });

      $('#btAccionVaciar').click(function() {
        resetTabla();
      });

      $('#btAccionForm').click(function() {
        openFormModal();
      });

      $('#formModal').click(function(event) {
        if (event.target === this) {
          closeFormModal();
        }
      });

      $('#modalCloseBtn').click(function() {
        closeFormModal();
      });

      resetTabla();
    });
  </script>
</body>

</html>
